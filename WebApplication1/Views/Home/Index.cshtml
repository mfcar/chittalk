@{
    /**/

    ViewBag.Title = "Home Page";
    List<String> list = (List<String>)ViewBag.ListOnlineUsers;
}

<br />

<style type="text/css">
    .sender-text
    {
        font-size: 8pt
    }

</style>

@section scripts{
    <script>

        var hook = true;
        window.onbeforeunload = function () {
            if (hook) {

                $.ajax({
                    url: '@Url.Action("removeUser", "Home")',
                    data: { user: '@ViewBag.n' },
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        set(data.msgss);
                        $("#onlineusers").text(data.onlineusers);
                    }
                });

                return "Did you save your stuff?"
            }
        }

        $(document).ready(function () {
            $("#txt-msg").on('keyup', function (e) {
                if (e.keyCode === 13) {
                    enviarmsg();
                }
            });

            get();
        });

        function enviarmsg() {
            $.ajax({
                url: '@Url.Action("setMsg", "Home")',
                data: { msg: $('#txt-msg').val(), nome: $('#hid-nome').val() },
                    type: "POST",
                    dataType: "json",
                    success: function (data) {
                        $('#txt-msg').val('');
                    }
                });
        }

        function get() {
            setInterval(function () {
                $.ajax({
                    url: '@Url.Action("getMgss", "Home")',
                    data: null,//{ CPF: cpf },
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        set(data.msgss);
                        
                        var htmlOnlineUsers = '';
                        for (var i = 0; i < data.onlineusers.length; i++) {
                            var usuario = data.onlineusers[i];
                            htmlOnlineUsers += '<li class="list-group-item list-group-item-primary">' + usuario + '</li>';
                        }

                        $('#onlineusers').html(htmlOnlineUsers);
                    }
                });
            }, 1000);
        }

        function set(data) {
            var html = '';
            for (var i = 0; i < data.length; i++) {
                var obj = data[i];
                var datehora = new Date(parseInt(data[0].datahora.replace('/Date(', '').replace(')/', '')));

                var usuario = obj.nome;
                html += '<li><b><span class="sender-text">[' + datehora.toLocaleString() + '] ' + obj.nome + '</span></b><br />' + formataTxt(obj.msg) + '</li>';
            }

            $('#ul-msg').html(html);
        }

        function formataTxt(fulltxt) {

            var palavras = fulltxt.split(' ');
            formatedText = '';

            for (var i = 0; i < palavras.length; i++) {

                var palavra = palavras[i];

                var regex = new RegExp(/[-a-zA-Z0-9@@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@@:%_\+.~#?&//=]*)?/gi);
                
                if (palavra.match(regex))
                {
                    if (palavra.indexOf('//') == -1)
                        formatedText = formatedText + ' <a target="_blank" href="//' + palavra + '">' + palavra + '</a>';
                    else
                        formatedText = formatedText + ' <a target="_blank" href="' + palavra + '">' + palavra + '</a>';
                }
                else
                {
                    formatedText = formatedText + ' ' + palavra;
                }
            }

            return formatedText;
        }

    </script>
}
    <div class="container-fluid">
        <input type="hidden" id="hid-nome" value="@ViewBag.n" />
        <label></label>
        <div class="row">
            <div class="col-3">
                <ul class="list-group" id="onlineusers"></ul>
            </div>
            <div class="col-9">
                <div class="jumbotron" style="overflow-y: scroll;height: 500px;">
                    <ul id="ul-msg"></ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-9 offset-3">
                <div class="form-group">
                    <div class="input-group mb-3">
                        <input type="text" id="txt-msg" class="form-control" placeholder="Mensagem" aria-label="Mensagem" aria-describedby="button-addon2">
                        <div class="input-group-append">
                            <button class="btn btn-outline-success" type="button" id="button-addon2" onclick="enviarmsg()">Enviar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

